<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>Facetime Me!</title>
  <meta name="description" content="Facetime Me!">
  <meta name="author" content="Dollop Labs">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <link rel="stylesheet" href="/static/css/style.css?v=2">
  <link rel="stylesheet" href="/static/css/960.css?v=2">
  <link rel="stylesheet" href="/static/css/ui-lightness/jquery-ui-1.8.7.custom.css?v=2">
</head>

<body>
    <div id="fb-root"></div>
    <script>
      window.fbAsyncInit = function() {
        FB.init({appId: '{{ facebook_app_id }}', status: true, cookie: true, xfbml: true});
        FB.Event.subscribe('{% if current_user %}auth.logout{% else %}auth.login{% endif %}', function(response) {
          window.location.reload();
        });
      };
      (function() {
        var e = document.createElement('script');
        e.type = 'text/javascript';
        e.src = document.location.protocol + '//connect.facebook.net/en_US/all.js';
        e.async = true;
        document.getElementById('fb-root').appendChild(e);
      }());
      
    </script>
    
    <div class="container_24">
        <div class="grid_12" id="header">
            <div style="text-align:center;">
                <h1>FACECALL.ME</h1>
            </div>
            
            <br />
            
            {% if current_user %}
                <div class="grid_2">
                    <a href="{{ current_user.profile_url }}"><img src="http://graph.facebook.com/{{ current_user.id }}/picture?type=square"/></a>
                </div>
                <div class="grid_10">
                    Hello, {{ current_user.name|escape }}<br />                    
                    <span id="facetime-email" style="{% if not current_user.facetime_email %}display:none;{% endif %}"><span id="facetime-email-text">{{ current_user.facetime_email|escape }}</span>&nbsp;<a href="#" id="update-email">change</a></span>
                    <form action="POST" id="facetime-email-form" style="{% if current_user.facetime_email %}display:none;{% endif %}">
                    <input type="email" name="email" id="email" value="{{ current_user.facetime_email|escape }}" />
                    <input type="submit" id="submit" value="Save" /><span id="submit-error"></span>
                    </form>
                </div>
            {% else %}
                <div style="text-align:center;">
                    <fb:login-button></fb:login-button>
                </div>
            {% endif %}
        </div>
        
        <div class="clear"></div>
        
        <div class="grid_12" style="margin-top:20px;">
            {% if current_user %}
                      {% if facetime_friends %}
                            {% for f in facetime_friends %}
                                {% if f.facetime_email %}
                                    <div class="grid_2">
                                        <img src="{{ f.picture }}"/>
                                    </div>
                                    <div class="grid_6">
                                        <a href="{{ f.profile_url }}" style="text-decoration:none;">{{ f.name }}</a>
                                    </div>
                                    <div class="grid_4">
                                        <a href="facetime://{{ f.facetime_email|escape }}">Call {{ f.first_name }}</a>
                                    </div>
                                {% endif %}
                            {% endfor %}
                      {% else %}
                        None of your friends are here... tell them to sign up!
                      {% endif %}
            {% endif %}
        </div>
        
        <div class="clear"></div>
        
        <div class="grid_12" style="margin-top:20px;text-align:center;">
            {% block footer %}
                {% if current_user %}
                        <fb:logout-button></fb:logout-button>
                {% endif %}
            
                <p>
                    <strong>Don't have FaceTime?</strong>
                    <br />
                    You need a mac with Snow Leopard (10.6) or an iPhone 4.
                    <br />
                    <a href="http://itunes.apple.com/us/app/facetime/id414307850">Get FaceTime for Mac</a>
                </p>
                <br /><br />
                
                FaceCall Me is Brought to you by Dollop Labs
            {% endblock %}
        </div>
    </div>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
  <script>!window.jQuery && document.write('<script src="{{ media_url }}js/jquery-1.5.0.min.js"><\/script>')</script>
  <!-- <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script> -->
  <!-- <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>  -->
  
  {% if current_user %}
    <script type="text/javascript">
        function validateEmail(email) 
        { 
            var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/ 
            return email.match(re) 
        }
      
        $('#update-email').click(function(){
            $('#facetime-email').hide();
            $('#facetime-email-form').show();            
        });
        
        $('#submit').click(function () {		
            var email = $('input[name=email]');
            if (!validateEmail(email.val())) {
                $('#submit-error').html('Invalid email');
                return false;
            }
        
            $('#submit-error').html('');            
            $('#facetime-email-form').hide();
            
            $.getJSON('/ajax/update_email', {email:email.val()}, function(data) {
                $('#facetime-email-text').html(data.email);
                $('#facetime-email').show();
                $('input[name=email]').val(data.email);
            }).error(function() { $('#facetime-email-form').show(); });
        
            return false;
        });
    </script>
  {% endif %}

  <script>
   var _gaq = [['_setAccount', 'UA-21703462-1'], ['_trackPageview']];
   (function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.async = true;
    g.src = ('https:' == location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g, s);
   })(document, 'script');
  </script>
  
</body>
</html>
